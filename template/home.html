<!DOCTYPE html>
<html lang="en">
<head>
<title>Chat Example</title>
<style type="text/css">
html {
    overflow: hidden;
}

body {
    overflow: hidden;
    padding: 0;
    margin: 0;
    width: 100%;
    height: 100%;
    background: gray;
}
#roomList {
    background: #fff;
    position: absolute;
    width: 6em;
    top: 0.5em;
    left: 0.5em;
    right: 0.5em;
    bottom: 0.5em;
    overflow: auto;
}
.room-box {
    position: relative;
    background: #c8c8c8;
    text-align: center;
    color: #fff;
    border-bottom: 1px solid #808080;
    padding: 0.5em;
}
.room-box.is-active {
    background: #4fe2fe;
}
.r-badge {
    position: absolute;
    display: inline-block;
    background: #f56c6c;
    padding: 0 4px;
    color: #fff;
    text-align: center;
    border-radius: 4px;
    right: 0;
    top: 0;
}
#log {
    background: #fff;
    margin: 0;
    padding: 0.5em 0.5em 0.5em 0.5em;
    position: absolute;
    top: 0.5em;
    left: 7em;
    right: 0.5em;
    bottom: 3.5em;
    overflow: auto;
}

#form {
    padding: 0.5em;
    background: #fff;
    margin: 0;
    position: absolute;
    bottom: 0.5em;
    left: 7em;
    width: 100%;
    overflow: hidden;
}
.other-box,
.self-box{
    margin-bottom: 20px;
}
.self-box {
    text-align: right;
}
.content-header {
    display: inline-block;
    width: 70px;
    padding: 8px;
    overflow:hidden;
    text-overflow:ellipsis;
    white-space:nowrap;
    vertical-align: top;
}
.content-header  .user-avatar {
    display: block;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    border: 1px solid #4f4f4f;
}
.content-body {
    display: inline-block;
    width: 400px;
    background-color: #808080;
    padding: 8px;
    border-radius: 4px;
    word-break: break-all;
    vertical-align: top;
}
.self-box .content-body {
    text-align: left;
}
.content-time {
    display: inline-block;
    width: auto;
    background-color: #fff;
    padding: 8px;
    border-radius: 4px;
    word-break: break-all;
    vertical-align: top;
    margin-left: 20px;
}
#contentBox {
    width: calc(100% - 300px);
}
#submitContent {
    margin-left: 20px;
}
[v-cloak] {
    display: none;
}
</style>
</head>
<body>
    <div id="app" v-cloak>
        <div id="roomList">
            <template v-for="(r, index) in rooms">
                <div class="room-box" :class="{'is-active' : r.isActive}"  @click="changeRoom(index)">
                    <span class="r-desc">{{r.des}}</span>
                    <span class="r-badge">{{r.unread}}</span>
                </div>
            </template>
        </div>
        <div id="log">
            <div v-for="message in messages">
                <div class="self-box" v-if="user==parseInt(message.from_uid)">
                    <span class="content-time">{{ message.create_date.split('.')[0] }}</span>
                    <span class="content-body">{{ message.content }}</span>
                    <span class="content-header">
                        <img :src="image_prefix + message.image" class="user-avatar"/>
                    <span>{{message.from_name}}</span>
                    </span>
                </div>
                <div class="other-box" v-else>
                    <span class="content-header">
                        <img :src="image_prefix + message.image" class="user-avatar"/>
                        <span>{{message.from_name}}</span>
                    </span>
                    <span class="content-body">{{ message.content }}</span>
                    <span class="content-time">{{ message.create_date.split('.')[0] }}</span>
                </div>


            </div>
        </div>
        <div id="form">
            <input id="contentBox" type="text" name="content" v-model="content" size="64" @keypress.enter="submitContent"/>
            <input id="submitContent" type="button" @click="submitContent" value="Submit"/>
        </div>
    </div>
</body>
<script src="http://cdn.staticfile.org/jquery/2.1.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script type="text/javascript">
    var app = new Vue({
        el: '#app',
        data: {
            user: 0,
            room_id: 0,
            rooms: [],
            conn: false,
            conn_room: false,
            content: "",
            messages: [],
            positions:[],
            username: "",
            image_prefix: "http://cdn.ggac.net/"
        },
        created: function() {
            this.get_room_list();
            this.websocket_unread_start();
        },
        methods: {
            get_user: function () {
                var that = this;
                $.ajax("/api/user", {
                    data: {},
                    dataType: 'json',
                    type: 'GET',
                    success: function(response) {
                        that.user = parseInt(response);
                    }
                });
            },
            get_room_list: function () {
                var that = this;
                $.ajax("/api/room/list", {
                    data: {},
                    dataType: 'json',
                    type: 'GET',
                    success: function(response) {
                        that.rooms = response;
                        that.changeRoom(0);
                        that.get_user();
                    }
                });
            },
            get_room_messages: function (room_id) {
                var that = this;
                $.ajax("/api/room/message/list", {
                    data: {
                        'room_id': room_id
                    },
                    dataType: 'json',
                    type: 'GET',
                    success: function(response) {
                        if (response === null)
                        {
                            that.messages = []
                        } else {
                            that.messages = response;
                            app.scrollToEnd();
                        }
                    }
                });
            },
            submitContent: function(){
                if(this.content.replace(/(^\s*)|(\s*$)/g, "")=="") {
                    alert("请输入数据");
                    return;
                }
                this.conn.send(this.content);
                app.scrollToEnd();
            },
            websocket_close: function(){
                if(this.conn) {
                    this.conn.close();
                }
            },
            websocket_unread_start: function () {
                if (window["WebSocket"]) {
                    this.conn_room = new WebSocket("ws://" + document.location.host + "/ws_unread");
                    this.conn_room.onmessage = function (evt) {
                        var messages = evt.data.split('\n');
                        console.log("recive room id:" + messages[0]);
                        app.reformRoomUnread(messages[0]);
                    };
                } else {
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                    this.appendLog(item);
                }
            },
            websocket_start: function(room_id){
                var that = this;
                if (window["WebSocket"]) {
                    this.conn = new WebSocket("ws://" + document.location.host + "/ws_message?room_id=" + room_id);
                    this.conn.onmessage = function (evt) {
                        console.log("get message evt" + evt);

                        var messages = evt.data.split('\n');
                        for (var i = 0; i < messages.length; i++) {
                            that.positions = [];
                            that.searchSubStr(messages[i], '&');
                            var room_id = messages[i].substring(0, that.positions[0]);
                            var create_date = messages[i].substring(that.positions[0]+1, that.positions[1]);
                            var user_id = messages[i].substring(that.positions[1]+1, that.positions[2]);
                            var user_name = messages[i].substring(that.positions[2]+1, that.positions[3]);
                            var image = messages[i].substring(that.positions[3]+1, that.positions[4] );
                            var content = messages[i].substring(that.positions[4]+1);
                            that.messages.push({
                                mid: 0,
                                content: content,
                                rid: room_id,
                                from_uid: user_id,
                                from_name: user_name,
                                image: image,
                                create_date: create_date
                            });
                        }
                        //app.reformRoomUnread(room_id); //reform room_id unread number
                        app.scrollToEnd(); //scroll to bottom
                    };
                } else {
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                    this.appendLog(item);
                }
            },
            appendLog: function(item) {
                var log = document.getElementById("log");
                var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
                log.appendChild(item);
                if (doScroll) {
                    log.scrollTop = log.scrollHeight - log.clientHeight;
                }
            },
            changeRoom: function (index) {
                this.messages = [];
                this.websocket_close();
                this.get_room_messages(app.rooms[index].rid);
                this.websocket_start(app.rooms[index].rid);
                app.reformActiveRoom(app.rooms[index].rid); //init active room
            },
            searchSubStr: function(str,subStr){
                var pos = str.indexOf(subStr);
                while(pos>-1){
                    app.positions.push(pos);
                    pos = str.indexOf(subStr,pos+1);
                }
            },
            scrollToEnd:function(){//滚动到底部
                $('#log').animate({scrollTop:$('#log').height() + 99999 + 'px'},100);
                app.content = "";
            },
            reformActiveRoom: function(room_id) {
                if(app.rooms.length>0) {
                    for(var i=0; i< app.rooms.length; i++) {
                        if(app.rooms[i].rid==room_id) {
                            Vue.set(app.rooms[i], 'isActive', true);
                            //current room unreadnumber==0
                            Vue.set(app.rooms[i], 'unread', 0);
                        } else {
                            Vue.set(app.rooms[i], 'isActive', false);
                        }
                    }
                }
            },
            reformRoomUnread: function(room_id) {
                for(var i=0; i< app.rooms.length; i++) {
                    if(parseInt(app.rooms[i].rid)==room_id) {
                        var oldUnreadNumber = app.rooms[i].unread;
                        Vue.set(app.rooms[i], 'unread', parseInt(oldUnreadNumber) + 1);
                    }
                }
            }
        }
    })
</script>
</html>
