<!DOCTYPE html>
<html lang="en">
<head>
<title>Chat Example</title>
<style type="text/css">
html {
    overflow: hidden;
}

body {
    overflow: hidden;
    padding: 0;
    margin: 0;
    width: 100%;
    height: 100%;
    background: gray;
}

#log {
    background: white;
    margin: 0;
    padding: 0.5em 0.5em 0.5em 0.5em;
    position: absolute;
    top: 0.5em;
    left: 0.5em;
    right: 0.5em;
    bottom: 3em;
    overflow: auto;
}

#form {
    padding: 0 0.5em 0 0.5em;
    margin: 0;
    position: absolute;
    bottom: 1em;
    left: 0px;
    width: 100%;
    overflow: hidden;
}

</style>
</head>
<body>
    <div id="app">
        <div id="log">
            <div v-for="message in messages">{{message.from_name}}:{{ message.content }}</div>
        </div>
        <div id="form">
            <input type="button" @click="submitContent" value="Submit"/>
            <input type="text" name="content" v-model="content" size="64"/>
            <select name="room" v-model="room_id" @change="changeRoom">
                <option :value="room.rid" v-for="room in rooms">{{ room.des }}</option>
            </select>
        </div>
    </div>
</body>
<script src="http://cdn.staticfile.org/jquery/2.1.0/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
<script type="text/javascript">
    var app = new Vue({
        el: '#app',
        data: {
            room_id: 0,
            rooms: [],
            conn: false,
            content: "",
            messages: [],
            username: ""
        },
        created: function() {
            this.get_room_list();
        },
        methods: {
            get_room_list: function () {
                var that = this;
                $.ajax("/api/room/list", {
                    data: {},
                    dataType: 'json',
                    type: 'GET',
                    success: function(response) {
                        that.rooms = response;
                    }
                });
            },
            get_room_messages: function (room_id) {
                var that = this;
                $.ajax("/api/room/message/list", {
                    data: {
                        'room_id': room_id
                    },
                    dataType: 'json',
                    type: 'GET',
                    success: function(response) {
                        if (response === null)
                        {
                            that.messages = []
                        } else {
                            that.messages = response
                        }
                    }
                });
            },
            submitContent: function(){
                this.conn.send(this.content);
            },
            websocket_close: function(){
                if(this.conn) {
                    this.conn.close();
                }
            },
            websocket_start: function(room_id){
                var that = this;
                if (window["WebSocket"]) {
                    this.conn = new WebSocket("ws://" + document.location.host + "/ws?room_id=" + room_id);
                    this.conn.onmessage = function (evt) {
                        var messages = evt.data.split('\n');
                        for (var i = 0; i < messages.length; i++) {
                            var message_array = messages[i].split('&');
                            var room_id = message_array[0];
                            var user_id = message_array[1];
                            var user_name = message_array[2];
                            var image = message_array[3];
                            var content = message_array[4];
                            var message_dict = {
                                mid: 0,
                                content: content,
                                rid: room_id,
                                from_uid: user_id,
                                from_name: user_name,
                                image: image
                            };
                            that.messages.push(message_dict);
                        }
                    };
                } else {
                    var item = document.createElement("div");
                    item.innerHTML = "<b>Your browser does not support WebSockets.</b>";
                    this.appendLog(item);
                }
            },
            appendLog: function(item) {
                var log = document.getElementById("log");
                var doScroll = log.scrollTop > log.scrollHeight - log.clientHeight - 1;
                log.appendChild(item);
                if (doScroll) {
                    log.scrollTop = log.scrollHeight - log.clientHeight;
                }
            },
            changeRoom: function () {
                this.messages = [];
                this.websocket_close();
                this.get_room_messages(this.room_id);
                this.websocket_start(this.room_id);
            }
        }
    })
</script>
</html>
